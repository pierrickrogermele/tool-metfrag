#!/bin/bash

# See http://c-ruttkies.github.io/MetFrag/projects/metfrag22cl/

#############
# CONSTANTS #
#############

SCRIPTDIR=$(dirname $0)

####################
# GET OPTION VALUE #
####################

function get_opt_val {
	if [ -z "$2" ] ; then
		printf "ERROR: \"$1\" requires a non-empty option argument.\n" >&2
		exit 1
	fi
	echo $2
}

#############
# READ ARGS #
#############

function read_args {
	while true ; do
		case $1 in
			-f|--file) g_param_file=$(get_opt_val $1 $2) ; shift ;;
			--pubchem) g_db=PubChem ;;
			--kegg) g_db=KEGG ;;
			*) break
		esac
		shift
	done
}

#####################
# CREATE PARAM FILE #
#####################

function create_param_file {
	cat >$g_param_file <<EOF
#	
# data file containing mz intensity peak pairs (one per line)	
#	
PeakListPath = exampledata.txt	
#
# Database parameters -> how to retrieve candidates	
#	
MetFragDatabaseType = $g_db
NeutralPrecursorMolecularFormula = C9H11Cl3NO3PS	
NeutralPrecursorMass = 348.926284	
#	
# peak matching parameters	
#	
FragmentPeakMatchAbsoluteMassDeviation = 0.001	
FragmentPeakMatchRelativeMassDeviation = 5	
PrecursorIonMode = 1	
IsPositiveIonMode = True	
#	
# scoring parameters	
#	
MetFragScoreTypes = FragmenterScore	
MetFragScoreWeights = 1.0	
#	
# output	
# SDF, XLS, CSV, ExtendedXLS, ExtendedFragmentsXLS	
#	
MetFragCandidateWriter = CSV
SampleName = example1	
ResultsPath = .	
#	
# following parameteres can be kept as they are	
#	
MaximumTreeDepth = 2	
MetFragPreProcessingCandidateFilter = UnconnectedCompoundFilter	
MetFragPostProcessingCandidateFilter = InChIKeyFilter	
# NumberThreads = 1
EOF
}

################
# CALL METFRAG #
################

function call_metfrag {
	java -jar $SCRIPTDIR/MetFrag2.2-CL.jar $g_param_file
}

########
# MAIN #
########

read_args "$@"

if [ -z "$g_param_file" ] ; then
	g_param_file=$(mktemp -t metfrag.XXXXXX)
	create_param_file
	call_metfrag
	rm $g_param_file
else
	call_metfrag
fi
